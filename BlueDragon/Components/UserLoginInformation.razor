@using BlueDragon.Models;
@using BlueDragon.Services;


@if (AuthService?.IsAuthorized != false)
{
    <MudIconButton Icon="@Icons.Material.Filled.Logout" OnClick="@Logout" Color="Color.Inherit" Href="" Target="_blank" />
}
else
{
    <MudIconButton Icon="@Icons.Material.Filled.Login" OnClick="Login" Color="Color.Inherit" Href="" Target="_blank" />
}

<MudDialog @bind-IsVisible="loginDialogVisible" Options="dialogOptions" DefaultFocus="DefaultFocus.LastChild">
    <TitleContent>
        <MudText Typo="Typo.h6">
            User Login
        </MudText>
    </TitleContent>
    <DialogContent>
        <EditForm Model="@login" OnValidSubmit="CheckAuthentication">
            <DataAnnotationsValidator />
            <MudCard>
                <MudCardContent>
                    <MudTextField @bind-Value="login.UserName"
                                  Label="Username"
                                  HelperText="Max. 50 characters"
                                  For="@(() => login.UserName)"
                                  Required="true"
                                  RequiredError="A Cable Type is required!" />
                    <MudTextField @bind-Value="login.Password"
                                  Label="Password"
                                  HelperText="Max. 50 characters"
                                  For="@(() => login.Password)"
                                  Required="true"
                                  InputType="InputType.Password"
                                  RequiredError="A Cable Type is required!" />
                </MudCardContent>
                <MudCardActions>
                    <MudButtonGroup Class="mx-auto" Color="Color.Primary" Variant="Variant.Filled">
                        <MudButton ButtonType="ButtonType.Submit" StartIcon="@Icons.Material.Filled.Save">Login</MudButton>
                        <MudButton OnClick='(() => Close())' StartIcon="@Icons.Material.Filled.Close">Close</MudButton>
                    </MudButtonGroup>
                </MudCardActions>
            </MudCard>
        </EditForm>
    </DialogContent>
</MudDialog>

@code {
    bool loginDialogVisible;
    LoginModel login = new();

    [Inject] UserService? UserService { get; set; }

    [Inject] private AuthService? AuthService { get; set; }

    [Inject] public NavigationManager? NavigationManager { get; set; }

    protected override void OnInitialized()
    {
        if (AuthService != null)
            AuthService.OnChange += StateHasChanged;
    }


    private async Task CheckAuthentication(EditContext context)
    {
        if (context != null && AuthService != null)
        {
            await AuthService.Login(login.UserName, login.Password);
            Close();
            StateHasChanged();
        }
    }
    private void Login()
    {
        loginDialogVisible = true;
    }

    private void Close()
    {
        loginDialogVisible = false;

    }

    private void Logout()
    {
        AuthService?.Logout();
        NavigationManager?.NavigateTo("/", true);
    }

    private DialogOptions dialogOptions = new()
        {
            FullWidth = true,
            CloseButton = true,
            DisableBackdropClick = true,
            Position = DialogPosition.TopCenter,
            MaxWidth = MaxWidth.Small
        };
}
